{% extends "base.html" %}
{% block title%}Замовлення {{order.id}}{% endblock %}
{% block content %}
    <h1>Замовлення №{{order.id}}</h1>
    <h2>Інформація про клієнта</h2>
    <div class="row"><div class="col-6">
        <p>Ім'я: {{order.client.first_name}}</p>
        <p>Прізвище: {{order.client.last_name}}</p>
        <p>Номер телефону: {{order.client.tel_number}}</p>
        <p>Email: {{order.client.email}}</p>
    </div class="col-6"></div>
    <h1>Додати товар</h1>
    <form method="post" action="{% url 'add_item' order.id %}">
        {% csrf_token %}
        <select id="product" name="product" style="width:300px;">
            {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }}</option>
            {% endfor %}
        </select>
        <input type="number" name="quantity" min="1" value="1">
        <button type="submit" class="btn btn-primary">Додати</button>
    </form>
    <h1>Товари</h1>
    <table border="1" class="table table-striped">
      <thead>
                    <tr>
                        <th>#</th>
                        <th>Назва товару</th>
                        <th>Кількість</th>
                        <th>Ціна</th>
                        <th>Дія</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.orderitems_set.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ item.product.name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.product.price }}</td>
                        <td>
                            <form method="post" action="{% url 'delete_item' item.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">Видалити</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">Товари відсутні</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-warning">
                        <td colspan="3"><strong>Разом:</strong></td>
                        <td><strong>{{ total_sum }}</strong></td>
                    </tr>
                </tbody>
    </table>
    <div class="row">
        <div class="col-9"></div>
        <!-- <div class="col-3"><button type="button" onclick="history.back()" class="btn btn-danger btn-sm">Назад</button> -->
        <div class="col-3">
            <form method="post" action="{% url 'orders_list' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Назад</button>
            </form>
        </div>
    </div>

<script>
$(document).ready(function() {
    $('#product').select2({
        placeholder: 'Введіть назву або ID товару',
        minimumInputLength: 1,
        ajax: {
            url: '{% url "products_autocomplete" %}', // Django URL для JSON
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return { q: params.term }; // term, що вводить користувач
            },
            processResults: function(data) {
                return {
                    results: data.map(function(item) {
                        return { id: item.id, text: item.name };
                    })
                };
            },
            cache: true
        }
    });
});
</script>
{% endblock %}